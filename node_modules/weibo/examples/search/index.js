/**
 * 
 * CREATE TABLE `status` (
  `id` int(11) NOT NULL auto_increment,
  `text` varchar(300) default NULL,
  `created_at` datetime default NULL,
  `user_name` varchar(200),
  `json` longtext,
  PRIMARY KEY  (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
 * 
 */

var tapi = require('weibo').tapi
  , Client = require('mysql').Client;

var db = new Client({
    host: 'localhost',
    port: 3306,
    user: 'root',
    password: '123456',
    database: 'weibo_search'
});

db.connect();

// change appkey to yours
var appkey = '3434422667', secret = '523f2d0d134bfd5aa138f9e5af828bf9';
tapi.init('tsina', appkey, secret);

var done = false, page = 19;
var user = {oauth_token_key: "95373d3908edfa574e0d70793c80bf68",
    oauth_token_secret: "80ca45e29cf7908fc5109a7ab06ded85",
    authtype: 'oauth'
};

function search() {
    tapi.search({user: user, q: '技术嘉年华', count: 100, page: page}, function(error, datas, response) {
        if(error) {
            console.error(page, error);
        } else {
            console.log('----------------------------------------');
            console.log(page, datas.length);
            if(datas.length === 0) {
                console.log('finished');
            } else {
                console.log(datas[0].user.screen_name, datas[0].text);
                console.log('--->');
                console.log(datas[datas.length - 1].user.screen_name, datas[datas.length - 1].text);
                for(var i = 0; i < datas.length; i++) {
                    var data = datas[i];
                    db.query('insert into status set `text`=?, `created_at`=?, `user_name`=?, `json`=?', 
                            [data.text, new Date(data.created_at).format(), data.user.screen_name, JSON.stringify(data)]);
                }
                page += 1;
                setTimeout(function() {
                    search();
                }, 60000);
            }
        }
    });
}

search();


